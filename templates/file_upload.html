{% extends "base.html" %}

{% block title %}Upload Documents - {{ course.name }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            
            <!-- Course Header -->
            <div class="text-center mb-5">
                <h1 class="display-6 mb-3">{{ course.name }}</h1>
                <p class="lead text-muted">Document Upload</p>
            </div>
            
            <!-- Welcome Message -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5>Hello, {{ person.first_name }}!</h5>
                    <p class="mb-0">
                        Please upload the required documents for the course. Accepted formats: PDF, DOC, DOCX, JPG, PNG.
                    </p>
                </div>
            </div>
            
            <!-- Upload Instructions -->
            <div class="alert alert-info">
                <h6><i class="fas fa-info-circle"></i> Upload Instructions:</h6>
                <ul class="mb-0">
                    <li>Maximum file size: 10 MB per file</li>
                    <li>Accepted formats: PDF, Word documents, Images (JPG, PNG)</li>
                    <li>You can upload multiple files</li>
                    <li>Files will be securely stored</li>
                </ul>
            </div>
            
            <!-- File Upload Form -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-paperclip"></i> Upload Your Documents</h5>               

 </div>
                <div class="card-body">
                    <form method="POST" 
                          action="{{ url_for('file_upload', token=person.token) }}" 
                          enctype="multipart/form-data"
                          id="uploadForm">
                        
                        <!-- File Input -->
                        <div class="mb-4">
                            <label for="files" class="form-label">
                                <strong>Select Files to Upload</strong> *
                            </label>
                            <input type="file" 
                                   class="form-control form-control-lg" 
                                   id="files" 
                                   name="files" 
                                   multiple 
                                   required
                                   accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                                   onchange="updateFileList()">
                            <div class="form-text">
                                You can select multiple files at once (hold Ctrl/Cmd while clicking)
                            </div>
                        </div>
                        
                        <!-- Selected Files Preview -->
                        <div id="fileListContainer" style="display: none;">
                            <h6 class="mb-3">Selected Files:</h6>
                            <div id="fileList" class="mb-4"></div>
                        </div>
                        
                        <!-- File Description -->
                        <div class="mb-4">
                            <label for="description" class="form-label">
                                Description or Notes <span class="text-muted">(Optional)</span>
                            </label>
                            <textarea class="form-control" 
                                      id="description" 
                                      name="description" 
                                      rows="3"
                                      placeholder="Add any notes about these files..."></textarea>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-gradient btn-lg" id="submitBtn">
                                <i class="fas fa-upload"></i> Upload Files
                            </button>
                        </div>
                        
                        <!-- Upload Progress -->
                        <div id="uploadProgress" class="mt-3" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     style="width: 0%"
                                     id="progressBar">0%</div>
                            </div>
                            <p class="text-center mt-2 text-muted">
                                <small>Uploading files... Please wait.</small>
                            </p>
                        </div>
                        
                    </form>
                </div>
            </div>
            
            <!-- Previously Uploaded Files -->
            {% if person.uploaded_files.count() > 0 %}
            <div class="card mt-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-check-circle"></i> Previously Uploaded Files</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>File Name</th>
                                    <th>Size</th>
                                    <th>Uploaded</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for file in person.uploaded_files %}
                                <tr>
                                    <td>
                                        <i class="fas fa-file-{{ file.file_extension }} text-primary"></i>
                                        {{ file.original_filename }}
                                    </td>                                    

<td>{{ (file.file_size / 1024 / 1024)|round(2) }} MB</td>
                                    <td>{{ file.uploaded_at.strftime('%b %d, %Y') }}</td>
                                    <td>
                                        <a href="{{ url_for('download_file', file_id=file.id, token=person.token) }}" 
                                           class="btn btn-sm btn-outline-primary"
                                           target="_blank">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if person.uploaded_files.count() > 0 %}
                    <div class="alert alert-success mb-0 mt-3">
                        <i class="fas fa-info-circle"></i>
                        <strong>Total Files Uploaded:</strong> {{ person.uploaded_files.count() }}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- Contact Information -->
            <div class="card mt-4 border-secondary">
                <div class="card-body text-center">
                    <small class="text-muted">
                        <i class="fas fa-question-circle"></i> 
                        Having trouble uploading? Contact us at 
                        <a href="mailto:{{ config.MAIL_DEFAULT_SENDER }}">{{ config.MAIL_DEFAULT_SENDER }}</a>
                    </small>
                </div>
            </div>
            
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById('files');
    const fileListContainer = document.getElementById('fileListContainer');
    const fileList = document.getElementById('fileList');
    const uploadForm = document.getElementById('uploadForm');
    const submitBtn = document.getElementById('submitBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    
    // Update file list preview
    function updateFileList() {
        const files = fileInput.files;
        
        if (files.length > 0) {
            fileListContainer.style.display = 'block';
            fileList.innerHTML = '';
            
            let totalSize = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                totalSize += file.size;
                
                const fileItem = document.createElement('div');
                fileItem.className = 'alert alert-light d-flex justify-content-between align-items-center mb-2';
                
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                const icon = getFileIcon(file.name);
                
                fileItem.innerHTML = `
                    <div>
                        <i class="fas fa-${icon} text-primary me-2"></i>
                        <strong>${file.name}</strong>
                        <small class="text-muted ms-2">(${fileSize} MB)</small>
                    </div>
                `;
                
                fileList.appendChild(fileItem);
            }
            
            // Show total size
            const totalSizeMB = (totalSize / 1024 / 1024).toFixed(2);
            const totalItem = document.createElement('div');
            totalItem.className = 'alert alert-info mb-0';
            totalItem.innerHTML = `
                <strong>Total:</strong> ${files.length} file(s), ${totalSizeMB} MB
            `;
            fileList.appendChild(totalItem);
            
            // Check if total size exceeds limit
            if (totalSize > 50 * 1024 * 1024) { // 50 MB total limit
                const warning = document.createElement('div');
                warning.                

warning.className = 'alert alert-danger mb-0 mt-2';
                warning.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> Total file size exceeds 50 MB. Please reduce the number of files.
                `;
                fileList.appendChild(warning);
                submitBtn.disabled = true;
            } else {
                submitBtn.disabled = false;
            }
        } else {
            fileListContainer.style.display = 'none';
        }
    }
    
    // Get appropriate icon for file type
    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const iconMap = {
            'pdf': 'file-pdf',
            'doc': 'file-word',
            'docx': 'file-word',
            'jpg': 'file-image',
            'jpeg': 'file-image',
            'png': 'file-image'
        };
        return iconMap[ext] || 'file';
    }
    
    // Handle form submission with progress
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(uploadForm);
        
        // Show progress bar
        uploadProgress.style.display = 'block';
        submitBtn.disabled = true;
        
        // Create XMLHttpRequest for progress tracking
        const xhr = new XMLHttpRequest();
        
        // Track upload progress
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                progressBar.style.width = percentComplete + '%';
                progressBar.textContent = Math.round(percentComplete) + '%';
            }
        });
        
        // Handle completion
        xhr.addEventListener('load', function() {
            if (xhr.status === 200) {
                window.location.href = "{{ url_for('file_upload_confirmation', token=person.token) }}";
            } else {
                alert('Upload failed. Please try again.');
                uploadProgress.style.display = 'none';
                submitBtn.disabled = false;
            }
        });
        
        // Handle errors
        xhr.addEventListener('error', function() {
            alert('Upload failed. Please check your connection and try again.');
            uploadProgress.style.display = 'none';
            submitBtn.disabled = false;
        });
        
        // Send request
        xhr.open('POST', uploadForm.action);
        xhr.send(formData);
    });
</script>

<style>
    .alert-light {
        border: 1px solid #dee2e6;
    }
    
    #fileList .alert {
        padding: 10px 15px;
    }
    
    .progress {
        height: 30px;
    }
    
    .progress-bar {
        font-size: 14px;
        line-height: 30px;
    }
</style>
{% endblock %}